# é€šä¿¡åè®®è¯¦è§£

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜?AI Assistant é¡¹ç›®ä½¿ç”¨çš„æ‰€æœ‰é€šä¿¡åè®®ã€‚AI Agent åœ¨éœ€è¦å®ç°æˆ–è°ƒè¯•é€šä¿¡åŠŸèƒ½æ—¶åº”é˜…è¯»æ­¤æ–‡æ¡£ã€?

---

## åè®®æ€»è§ˆ

> **CRITICAL**: é»˜è®¤é‡‡ç”¨ MQTT+UDP ç½‘å…³æ¨¡å¼ï¼ŒESP32 æœ¬è´¨ä¸Šæ˜¯ IoT è®¾å¤‡ã€?

| åè®®              | ç”¨é€?                 | ä¼˜å…ˆçº?    | æ–‡æ¡£ä½ç½®                                 |
| ----------------- | --------------------- | ---------- | ---------------------------------------- |
| **MQTT+UDP** âœ?  | IoT è®¾å¤‡ç½‘å…³æ¥å…¥ (é»˜è®¤) | é»˜è®¤       | æœ¬æ–‡æ¡?                                  |
| **WebSocket**     | å¼€å‘è°ƒè¯•ç›´è¿?         | ä»…å¼€å‘è°ƒè¯?| `third_party/xiaozhi-esp32/docs/websocket.md`    |
| **MCP**           | è®¾å¤‡æ§åˆ¶              | ä¸¤ç§æ¨¡å¼é€šç”¨ | `third_party/xiaozhi-esp32/docs/mcp-protocol.md` |

---

## WebSocket åè®® (ç›´è¿æ¨¡å¼ - ä»…å¼€å‘è°ƒè¯?

> âš ï¸ **æ³¨æ„**: æ­¤æ¨¡å¼ä»…å»ºè®®ç”¨äºå¼€å‘è°ƒè¯•ã€‚ç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨ MQTT+UDP ç½‘å…³æ¨¡å¼ã€?

### æ¡æ‰‹æµç¨‹

1. **è®¾å¤‡è¿æ¥** â†?å‘é€?`hello` æ¶ˆæ¯ (å?audio_params)
2. **æœåŠ¡ç«¯å›å¤?* `hello` æ¶ˆæ¯ (å?session_id)
3. **åŒå‘é€šä¿¡** â†?Opus éŸ³é¢‘æµ?+ JSON æ§åˆ¶æ¶ˆæ¯

### æ¶ˆæ¯ç±»å‹

| ç±»å‹      | æ–¹å‘        | ç”¨é€?         |
| --------- | ----------- | ------------- |
| `hello`   | åŒå‘        | æ¡æ‰‹æ¶ˆæ¯      |
| `listen`  | åŒå‘        | å¼€å§?åœæ­¢ç›‘å¬ |
| `stt`     | æœåŠ¡ç«¯â†’è®¾å¤‡ | è¯­éŸ³è¯†åˆ«ç»“æœ  |
| `tts`     | æœåŠ¡ç«¯â†’è®¾å¤‡ | è¯­éŸ³åˆæˆæ§åˆ¶  |
| `llm`     | æœåŠ¡ç«¯â†’è®¾å¤‡ | è¡¨æƒ…/æƒ…ç»ªæ§åˆ¶ |
| `mcp`     | åŒå‘        | è®¾å¤‡æ§åˆ¶åè®®  |
| `goodbye` | åŒå‘        | æ–­å¼€è¿æ¥      |

### éŸ³é¢‘ä¼ è¾“

- **ç¼–ç **: Opus
- **å¸§ç±»å?*: Binary
- **é‡‡æ ·ç?*: 16kHz (é€šå¸¸)

---

## MCP åè®® (è®¾å¤‡æ§åˆ¶)

åŸºäº **JSON-RPC 2.0**ï¼Œç”¨äºæœåŠ¡ç«¯æ§åˆ¶ ESP32 è®¾å¤‡ã€?

### æ–¹æ³•åˆ—è¡¨

| æ–¹æ³•         | ç”¨é€?            |
| ------------ | ---------------- |
| `tools/list` | è·å–è®¾å¤‡èƒ½åŠ›åˆ—è¡¨ |
| `tools/call` | è°ƒç”¨è®¾å¤‡åŠŸèƒ½     |

### è¯·æ±‚ç¤ºä¾‹

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "set_volume",
    "arguments": {
      "volume": 80
    }
  }
}
```

### å“åº”ç¤ºä¾‹

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "success": true,
    "message": "Volume set to 80"
  }
}
```

### å¸¸ç”¨å·¥å…·

- éŸ³é‡æ§åˆ¶
- ç¯å…‰/LED æ§åˆ¶
- GPIO æ“ä½œ
- ç³»ç»Ÿä¿¡æ¯è·å–

---

## MQTT ç½‘å…³åè®® (IoT è®¾å¤‡æ¥å…¥) - âœ?é»˜è®¤æ¨¡å¼

> **CRITICAL**: è¿™æ˜¯é¡¹ç›®çš„é»˜è®¤é€šä¿¡æ¶æ„ã€‚ESP32 æœ¬è´¨ä¸Šæ˜¯ IoT è®¾å¤‡ï¼Œç½‘å…³æ¨¡å¼æ›´ç¬¦åˆ IoT è®¾å¤‡çš„é€šä¿¡èŒƒå¼ã€?

ç½‘å…³å°?IoT è®¾å¤‡å¸¸ç”¨çš?MQTT+UDP åè®®è½¬æ¢ä¸?WebSocket åè®®ã€?

**è®¾è®¡å†³ç­–**:
- **MQTT**: ç”¨äº JSON æ§åˆ¶æ¶ˆæ¯ (ä½å¸¦å®½ã€å¯é ä¼ è¾“ã€æ¶ˆæ¯é˜Ÿåˆ?
- **UDP**: ç”¨äºéŸ³é¢‘æµ?(ä½å»¶è¿Ÿã€å®æ—¶æ€§ã€ä¸¢åŒ…å¯å®¹å¿)
- **ç½‘å…³**: åè®®è½¬æ¢ + éŸ³é¢‘åŠ è§£å¯?+ è®¾å¤‡è®¤è¯

### æ•°æ®æµ?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä¸Šè¡Œæ•°æ®æµ?(ç”¨æˆ·è¯­éŸ³ â†?AI) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”?
â”?                                                                 â”?
â”? ESP32 â”€â”€MQTTâ”€â”€â–?Gateway â”€â”€WebSocketâ”€â”€â–?Cloud                   â”?
â”?        (JSONæ§åˆ¶)        (JSONæ§åˆ¶)                              â”?
â”?                                                                 â”?
â”? ESP32 â”€â”€UDPâ”€â”€â”€â–?Gateway â”€â”€WebSocketâ”€â”€â–?Cloud                   â”?
â”?     (åŠ å¯†Opus)     (è§£å¯†)    (Binary)                           â”?
â”?                                                                 â”?
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä¸‹è¡Œæ•°æ®æµ?(AIå›å¤ â†?ç”¨æˆ·) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”?
â”?                                                                 â”?
â”? Cloud â”€â”€WebSocketâ”€â”€â–?Gateway â”€â”€MQTTâ”€â”€â–?ESP32                   â”?
â”?       (JSONæ§åˆ¶)            (JSONæ§åˆ¶)                          â”?
â”?                                                                 â”?
â”? Cloud â”€â”€WebSocketâ”€â”€â–?Gateway â”€â”€UDPâ”€â”€â”€â–?ESP32                   â”?
â”?       (Binary)        (åŠ å¯†)   (åŠ å¯†Opus)                        â”?
â”?                                                                 â”?
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”?
```

### MQTT è®¾å¤‡è®¤è¯

| å­—æ®µ       | æ ¼å¼                             | è¯´æ˜                          |
| ---------- | -------------------------------- | ----------------------------- |
| `clientId` | `{GroupID}@@@{MACåœ°å€}@@@{UUID}` | è®¾å¤‡å”¯ä¸€æ ‡è¯†                  |
| `username` | Base64 ç¼–ç çš?JSON               | ç”¨æˆ·æ•°æ®                      |
| `password` | `HMAC-SHA256(clientId + "        | " + username, SIGNATURE_KEY)` | ç­¾å |

### UDP éŸ³é¢‘åŠ å¯†

| é¡¹ç›®       | è¯´æ˜                           |
| ---------- | ------------------------------ |
| **ç®—æ³•**   | AES-128-CTR                    |
| **å¯†é’¥**   | æ¯æ¬¡ä¼šè¯ç”Ÿæˆéšæœº 16 å­—èŠ‚       |
| **å¸§æ ¼å¼?* | 16å­—èŠ‚ Header + åŠ å¯† Opus æ•°æ® |

### UDP Header æ ¼å¼ (16å­—èŠ‚)

| Offset | Size | Field         | è¯´æ˜             |
| ------ | ---- | ------------- | ---------------- |
| 0      | 1    | type          | 1=éŸ³é¢‘           |
| 2      | 2    | payloadLength | è´Ÿè½½é•¿åº¦         |
| 4      | 4    | connectionId  | è¿æ¥ID           |
| 8      | 4    | timestamp     | æ—¶é—´æˆ?(60ms/å¸? |
| 12     | 4    | sequence      | åºåˆ—å?          |

### ç½‘å…³ç®¡ç† API

#### è®¾å¤‡æŒ‡ä»¤ä¸‹å‘ (MCP)

```http
POST /api/commands/:clientId
Content-Type: application/json

{
  "type": "mcp",
  "payload": {
    "method": "tools/call",
    "params": {
      "name": "set_volume",
      "arguments": {"volume": 80}
    }
  }
}
```

#### æ‰¹é‡è®¾å¤‡çŠ¶æ€æŸ¥è¯?

```http
POST /api/devices/status
Content-Type: application/json

{
  "clientIds": ["GID@@@MAC1@@@UUID1", "GID@@@MAC2@@@UUID2"]
}
```

---

## åè®®å®ç°å‚è€?

### ç›´è¿æ¨¡å¼å®ç°

å‚è€?`third_party/xiaozhi-esp32-server/main/xiaozhi-server/core/` ç›®å½•ï¼?
- `handle/` - è¿æ¥å¤„ç†å’Œæ¶ˆæ¯åˆ†å?
- `providers/` - ASR/LLM/TTS æä¾›è€?

### ç½‘å…³æ¨¡å¼å®ç°

å‚è€?`third_party/xiaozhi-mqtt-gateway/` ç›®å½•ï¼?
- `app.js` - ä¸»å…¥å£ï¼ŒMQTT/UDP/WebSocket æ¡¥æ¥
- `mqtt-protocol.js` - MQTT åè®®è§£æ
- `utils/mqtt_config_v2.js` - è®¾å¤‡è®¤è¯

### MCP å®ç°

å‚è€?`third_party/mcp-endpoint-server/src/` ç›®å½•ï¼?
- `server.py` - FastAPI ä¸»æœåŠ?
- `core/connection_manager.py` - è¿æ¥ç®¡ç†
- `handlers/websocket_handler.py` - æ¶ˆæ¯å¤„ç†
