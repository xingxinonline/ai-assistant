# 系统架构说明

本文档详细说明 AI Assistant 项目的系统架构和部署模式。

---

## 架构概览

AI Assistant 是一个端到端的语音聊天助手项目，基于 **小智 AI** 开源生态构建。

```
用户语音 → ESP32采集 → 云端ASR → LLM对话 → TTS合成 → ESP32播放
```

---

## 整体架构

> **CRITICAL**: 默认采用网关模式 (MQTT+UDP → WebSocket)

```
┌────────────────────────────────────────────────────────────────────────────────┐
│                                 系统架构                                        │
├────────────────────────────────────────────────────────────────────────────────┤
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────────┐ │
│  │  应用层 (用户入口)                                                        │ │
│  │                                                                          │ │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐         │ │
│  │  │ Web 智控台  │  │ 移动端 App  │  │   小程序    │  │  H5 页面   │         │ │
│  │  │ (Vue.js)   │  │ (uni-app)  │  │ (微信/支付宝)│  │           │         │ │
│  │  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘         │ │
│  │        └───────────────┴───────────────┴───────────────┘                 │ │
│  │                                │                                         │ │
│  │                                ▼                                         │ │
│  │                    ┌───────────────────────┐                             │ │
│  │                    │   智控台后端 (Java)    │                             │ │
│  │                    │   • 用户管理/认证      │                             │ │
│  │                    │   • 设备绑定/配置      │                             │ │
│  │                    │   • OTA 升级          │                             │ │
│  │                    └───────────────────────┘                             │ │
│  └──────────────────────────────────────────────────────────────────────────┘ │
│                                      │                                        │
│  ┌─────────────┐   ┌─────────────┐   │   ┌────────────────────────────────┐  │
│  │  设备层      │   │  网关层      │   │   │  后端服务层                     │  │
│  │             │   │             │   │   │                                │  │
│  │  ESP32      │   │  Gateway    │   │   │  ┌────────────────────────┐   │  │
│  │  • 音频采集  │◄─►│  • 协议转换  │◄──┼──►│  │   WebSocket Server     │   │  │
│  │  • MCP 工具  │   │  • 音频加密  │   │   │  │   • ASR/LLM/TTS        │   │  │
│  │  • 显示屏    │   │  • 设备认证  │   │   │  │   • 会话管理            │   │  │
│  │             │   │             │   │   │  │   • 意图识别            │   │  │
│  └─────────────┘   └─────────────┘   │   │  └───────────┬────────────┘   │  │
│                                      │   │              │                │  │
│                                      │   │              ▼                │  │
│                                      │   │  ┌────────────────────────┐   │  │
│                                      │   │  │   MCP 服务层            │   │  │
│                                      │   │  │                        │   │  │
│                                      │   │  │  ┌──────┐ ┌──────────┐ │   │  │
│                                      │   │  │  │Mem0  │ │LightRAG  │ │   │  │
│                                      │   │  │  │记忆   │ │知识库    │ │   │  │
│                                      │   │  │  └──────┘ └──────────┘ │   │  │
│                                      │   │  │  ┌──────┐ ┌──────────┐ │   │  │
│                                      │   │  │  │定时   │ │声纹识别  │ │   │  │
│                                      │   │  │  │提醒   │ │         │ │   │  │
│                                      │   │  │  └──────┘ └──────────┘ │   │  │
│                                      │   │  └───────────┬────────────┘   │  │
│                                      │   │              │                │  │
│                                      │   │              ▼                │  │
│                                      │   │  ┌────────────────────────┐   │  │
│                                      │   │  │   存储层                │   │  │
│                                      │   │  │  Redis │ Qdrant │ MySQL │   │  │
│                                      │   │  └────────────────────────┘   │  │
│                                      │   └────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────────────────────┘
```

---

## 连接模式

### 网关模式 (默认)

**适用场景**: IoT 设备、低功耗场景、NAT 穿透、生产环境

```
ESP32 ──(MQTT+UDP)──► Gateway ──(WebSocket)──► Python Server
```

**设计决策**:
- **MQTT**: JSON 控制消息 (低带宽、可靠)
- **UDP**: 音频流 (低延迟、实时性)
- **网关**: 协议转换 + 音频加解密 + 设备认证

**特点**:
- 支持 NAT 穿透，设备无需公网 IP
- 设备可低功耗休眠
- HMAC-SHA256 设备认证
- AES-128-CTR 音频加密

### 直连模式 (仅开发调试)

```
ESP32 ──(WebSocket + Opus)──► Python Server
```

---

## 应用层

用户通过多端应用与系统交互：

| 应用 | 技术栈 | 功能 |
|------|--------|------|
| **Web 智控台** | Vue.js | 设备管理、模型配置、用户管理 |
| **移动端 App** | uni-app | iOS/Android 原生应用 |
| **微信小程序** | uni-app | 轻量级入口 |
| **H5 页面** | uni-app | 浏览器访问 |

### 智控台功能

- 用户注册/登录/认证
- 设备绑定/解绑
- AI 模型配置 (ASR/LLM/TTS 选择)
- 对话参数调整
- OTA 固件升级
- 数据统计/日志查看

---

## MCP 服务层

为 LLM 提供工具调用能力的核心服务：

| 服务 | 端口 | 用途 |
|------|------|------|
| **Mem0 MCP** | 3001 | 长期记忆 - 用户偏好、历史对话 |
| **LightRAG MCP** | 3002 | 知识库 - 私有知识、图谱检索 |
| **Scheduler MCP** | 3003 | 定时提醒 - 对话式交互、确认重试 |
| **Voiceprint** | 8005 | 声纹识别 - 说话人识别 |

### MCP 工具清单

**Mem0 (记忆)**:
- `memory.add` - 添加记忆
- `memory.search` - 搜索记忆
- `memory.get_context` - 获取对话上下文

**LightRAG (知识库)**:
- `knowledge.query` - 查询知识 (支持 hybrid 模式)
- `knowledge.insert` - 插入知识
- `knowledge.get_entities` - 获取图谱实体

**Scheduler (提醒)**:
- `reminder.create` - 创建提醒
- `reminder.list` - 列出提醒
- `reminder.confirm` - 确认提醒

---

## 核心流程

### 语音对话流程

```
1. 用户语音输入
   │
   ▼
2. ESP32 采集 → Opus 编码 → UDP 传输
   │
   ▼
3. Gateway 解密 → WebSocket 转发
   │
   ▼
4. ASR 语音识别
   │
   ├──► 并行: Mem0 获取记忆
   │
   ├──► 并行: LightRAG 查询知识
   │
   ▼
5. LLM 对话 (融合记忆+知识)
   │
   ▼
6. TTS 语音合成 → 音频回传
   │
   ▼
7. 保存新记忆到 Mem0
```

### 定时提醒流程

```
1. 用户: "明天8点提醒我吃药"
   │
   ▼
2. LLM 解析 → Scheduler.reminder.create
   │
   ▼
3. BullMQ Job 入队 (delay 到明天8点)
   │
   ▼
4. Job 触发 → Gateway 唤醒设备
   │
   ▼
5. 建立对话会话 → 播放提醒
   │
   ├──► 普通提醒: 30秒无响应自动关闭
   │
   └──► 确认提醒: 等待用户确认，超时重试 (最多3次)
```

---

## 服务端口分配

### 核心服务

| 服务 | 端口 | 说明 |
|------|------|------|
| WebSocket Server | 8000 | Python 语音服务 |
| MQTT Broker | 1883 | 设备连接 |
| Gateway API | 8007 | 网关管理 |

### MCP 服务

| 服务 | 端口 | 说明 |
|------|------|------|
| Mem0 MCP | 3001 | 记忆服务 |
| LightRAG MCP | 3002 | 知识库服务 |
| Scheduler MCP | 3003 | 定时提醒服务 |
| Voiceprint API | 8005 | 声纹识别服务 |

### 智控台

| 服务 | 端口 | 说明 |
|------|------|------|
| Manager Web | 8001 | Vue.js 前端 |
| Manager API | 8002 | Java Spring Boot 后端 |

### 存储服务

| 服务 | 端口 | 说明 |
|------|------|------|
| Redis | 6379 | 缓存/队列/会话 |
| Qdrant | 6333 | 向量数据库 |
| MySQL | 3306 | 关系数据库 |

---

## 存储设计

| 存储 | 用途 |
|------|------|
| **Redis** | 会话缓存、任务队列 (BullMQ)、用户索引 |
| **Qdrant** | 向量存储 (记忆、知识库) |
| **MySQL** | 用户数据、设备绑定 (智控台) |

---

## 部署建议

### 开发环境 (最小部署)

```
ESP32 ──(MQTT+UDP)──► Gateway ──(WS)──► Python Server
                                              │
                                        Redis + Qdrant
```

### 生产环境 (完整部署)

```
                    ┌─────────────────────────────────────────┐
                    │              应用层                      │
                    │  Web智控台 │ 移动App │ 小程序 │ H5      │
                    └──────────────────┬──────────────────────┘
                                       │
                                       ▼
                    ┌─────────────────────────────────────────┐
                    │         智控台后端 (Java)                │
                    │         用户管理 │ 设备配置 │ OTA       │
                    └──────────────────┬──────────────────────┘
                                       │
ESP32 ──(MQTT+UDP)──► Gateway ──(WS)──►│◄── Python Server
                                       │          │
                                       │    ┌─────┴─────┐
                                       │    │  MCP 服务  │
                                       │    │  Mem0     │
                                       │    │  LightRAG │
                                       │    │  Scheduler│
                                       │    │  Voiceprint│
                                       │    └─────┬─────┘
                                       │          │
                                       ▼          ▼
                    ┌─────────────────────────────────────────┐
                    │              存储层                      │
                    │     Redis │ Qdrant │ MySQL              │
                    └─────────────────────────────────────────┘
```

### Docker 服务清单

| 服务 | 必需 | 说明 |
|------|------|------|
| Redis | ✅ | 缓存/队列/会话 |
| Qdrant | ✅ | 向量数据库 |
| Gateway | ✅ | MQTT+UDP 网关 |
| Python Server | ✅ | 语音服务核心 |
| Mem0 MCP | 可选 | 长期记忆 |
| LightRAG MCP | 可选 | 知识库 |
| Scheduler MCP | 可选 | 定时提醒 |
| Voiceprint | 可选 | 声纹识别 |
| MySQL | 可选 | 智控台数据 |
| Manager API | 可选 | 智控台后端 |
| Manager Web | 可选 | 智控台前端 |

---

## 扩展性设计

### Provider 模式

所有 AI 模块采用 Provider 模式，便于替换：

```python
# ASR Provider
class ASRProviderBase:
    async def transcribe(self, audio: bytes) -> str: ...

# LLM Provider  
class LLMProviderBase:
    async def chat(self, messages: list) -> str: ...

# TTS Provider
class TTSProviderBase:
    async def synthesize(self, text: str) -> bytes: ...
```

### 水平扩展

- **Python Server**: 无状态设计，可多实例负载均衡
- **Gateway**: 可按设备分片部署
- **MCP 服务**: 独立部署，按需扩展
