# 系统架构说明

本文档详细说明 AI Assistant 项目的系统架构和部署模式。AI Agent 在需要理解整体系统设计时应阅读此文档。

---

## 架构概览

AI Assistant 是一个端到端的语音聊天助手项目，基于 **小智 AI** 开源生态构建。

### 核心数据流

```
用户语音 → ESP32采集 → 云端ASR → LLM对话 → TTS合成 → ESP32播放
```

---

## 连接模式

### 模式一：直连模式 (WebSocket) - 仅开发调试

**适用场景**: 开发测试、低延迟要求、稳定网络环境

> ℹ️ **注意**: 此模式仅建议用于开发调试。生产环境请使用网关模式。

```
┌───────────────────┐    WebSocket + Opus     ┌─────────────────────────────┐
│   ESP32 硬件端     │ ◄─────────────────────► │      Python 云端服务          │
│  xiaozhi-esp32    │     双向音频+控制         │   xiaozhi-esp32-server       │
│                   │                         │                             │
│  • 音频采集/播放    │                         │  • ASR: FunASR/火山/讯飞     │
│  • 唤醒词检测      │                         │  • LLM: 智谱/电豆/DeepSeek   │
│  • 显示屏/LED      │                         │  • TTS: Edge/火山/阿里云     │
│  • MCP 设备控制    │                         │  • VAD: SileroVAD          │
└───────────────────┘                         │  • 意图识别/记忆/插件       │
                                              └──────────────┬──────────────┘
                                                             │
                                                             ▼
                                              ┌─────────────────────────────┐
                                              │         AI 服务              │
                                              │  • 智谱 GLM  • 电豆 Doubao   │
                                              │  • Gitee AI  • 火山引擎      │
                                              └─────────────────────────────┘
```

**特点**:
- ✅ 延迟低，实时性好
- ✅ 实现简单
- ❌ 需要设备直接暴露到公网

---

### 模式二：网关模式 (MQTT+UDP → WebSocket) - ✅ 默认推荐

**适用场景**: IoT 设备、低功耗场景、NAT 穿透、生产环境

> **CRITICAL**: ESP32 本质上是 IoT 设备，网关模式更符合 IoT 设备的通信范式。
> 所有新功能开发应默认基于此模式设计。

```
┌───────────────────┐                     ┌───────────────────┐                     ┌─────────────────────┐
│   ESP32 硬件端     │   MQTT (JSON控制)   │    MQTT 网关       │   WebSocket (JSON)  │   Python 云端服务    │
│  xiaozhi-esp32    │ ◄────────────────► │ xiaozhi-mqtt-gw   │ ◄────────────────► │ xiaozhi-esp32-server│
│                   │   UDP (加密Opus)    │                   │   WebSocket (Binary)│                     │
│  • 音频采集/播放    │ ◄────────────────► │  • 协议转换        │ ◄────────────────► │  • ASR/LLM/TTS      │
│  • 唤醒词检测      │                     │  • 音频加解密      │                     │  • MCP 调度         │
│  • MCP 设备控制    │                     │  • 设备认证        │                     │  • 意图/记忆        │
└───────────────────┘                     │  • REST API       │                     └─────────────────────┘
                                          └───────────────────┘
```

**特点**:
- ✅ 支持 NAT 穿透
- ✅ 设备可低功耗休眠
- ✅ 集中式设备管理
- ✅ 符合 IoT 设备通信范式
- ✅ 支持设备认证和加密
- ⚠️ 需要额外部署网关

**网关模式设计决策**:
- MQTT 用于 JSON 控制消息 (低带宽、可靠)
- UDP 用于音频流 (低延迟、实时性)
- 网关负责协议转换和音频加解密

---

### 模式三：全模块部署架构 (基于网关模式)

**适用场景**: 生产环境、完整功能需求

```
┌───────────────────────────────────────────────────────────────────────────────────┐
│                              全模块部署架构                                        │
├───────────────────────────────────────────────────────────────────────────────────┤
│                                                                                   │
│  ┌───────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐       │
│  │ ESP32 设备  │     │  MQTT 网关    │     │ Python Server │     │   智控台      │       │
│  │           │ ◄─► │ :1883/:8007  │ ◄─► │    :8000     │ ◄─► │   :8002     │       │
│  │ • 音频采集   │     │ • 协议转换    │     │ • ASR/LLM/TTS │     │ • 用户管理   │       │
│  │ • MCP 工具  │     │ • 音频加解密  │     │ • VAD/Intent  │     │ • 模型配置   │       │
│  └───────────┘     │ • 设备认证    │     │ • Memory      │     │ • 参数配置   │       │
│        │           └─────────────┘     │ • Plugins     │     │ • OTA 升级   │       │
│        │                               └──────┬──────┘     └─────────────┘       │
│        │                                      │                                   │
│        ▼                                      ▼                                   │
│  ┌───────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐       │
│  │ MCP 接入点  │     │  声纹识别     │     │   MySQL      │     │    Redis     │       │
│  │   :8004    │     │   :8005      │     │   :3306      │     │    :6379     │       │
│  │           │     │              │     │              │     │              │       │
│  │ • 工具注册   │     │ • 3D-Speaker │     │ • 用户数据    │     │ • 会话缓存   │       │
│  │ • 消息转发   │     │ • 说话人识别  │     │ • 设备绑定    │     │ • Token缓存  │       │
│  └───────────┘     └─────────────┘     └─────────────┘     └─────────────┘       │
│                                                                                   │
└───────────────────────────────────────────────────────────────────────────────────┘
```

---

## 服务端口分配

| 服务              | 端口 | 协议      | 说明             |
| ----------------- | ---- | --------- | ---------------- |
| xiaozhi-server    | 8000 | WebSocket | Python 语音服务  |
| manager-web       | 8001 | HTTP      | Vue 智控台前端   |
| manager-api       | 8002 | HTTP      | Java 智控台后端  |
| mcp-endpoint      | 8004 | WebSocket | MCP 工具注册中心 |
| voiceprint-api    | 8005 | HTTP      | 声纹识别服务     |
| MySQL             | 3306 | TCP       | 数据库           |
| Redis             | 6379 | TCP       | 缓存             |
| MQTT Broker       | 1883 | MQTT      | 设备连接         |
| MQTT Gateway HTTP | 8007 | HTTP      | 网关管理 API     |

---

## 核心处理流程

### ASR → LLM → TTS 流水线

```
1. 音频输入
   │
   ▼
2. VAD 检测 (SileroVAD)
   │ 检测语音活动
   ▼
3. ASR 语音识别
   │ FunASR / 火山 / 讯飞 / 阿里云
   ▼
4. 意图识别
   │ function_call / intent_llm
   ▼
5. LLM 对话
   │ 智谱GLM / 电豆 / DeepSeek
   ▼
6. TTS 语音合成
   │ EdgeTTS / 火山 / 阿里云
   ▼
7. 音频输出
```

### MCP 设备控制流程

```
1. LLM 识别控制意图
   │
   ▼
2. 构造 MCP 请求 (JSON-RPC)
   │
   ▼
3. 通过 WebSocket 发送到设备
   │
   ▼
4. ESP32 执行控制 (音量/灯光/GPIO)
   │
   ▼
5. 返回执行结果
```

---

## 部署建议

> **CRITICAL**: 所有环境应优先采用网关模式，确保架构一致性。

### 开发环境

```bash
# 推荐: 本地网关模式 (与生产一致)
ESP32 ──(MQTT+UDP)──► Gateway (本地) ──(WS)──► Python Server (本地)

# 备选: 直连模式 (仅快速原型验证)
ESP32 ──(WebSocket)──► Python Server (本地)
```

### 测试环境

```bash
# 网关模式 + 智控台
ESP32 ──(MQTT+UDP)──► Gateway ──(WS)──► Python Server
                                              ↕
                                         MySQL + Redis
                                              ↕
                                         Manager API/Web
```

### 生产环境

```bash
# 完整部署: 网关模式 + 所有服务
ESP32 ──(MQTT+UDP)──► Gateway ──(WS)──► Python Server
                                              ↕
                          MySQL + Redis + 声纹 + MCP
                                              ↕
                                         Manager 全套
```

---

## 扩展性设计

### 水平扩展点

- **Python Server**: 无状态设计，可多实例负载均衡
- **MQTT Gateway**: 可按设备分片部署
- **Manager API**: Spring Boot 支持集群部署

### 插件扩展

- `plugins_func/` 目录下添加新功能
- 支持天气、新闻、音乐等插件
- 通过意图识别自动路由

### 模型替换

所有 AI 模块采用 Provider 模式：
- `core/providers/asr/` - ASR 提供者
- `core/providers/llm/` - LLM 提供者
- `core/providers/tts/` - TTS 提供者

添加新模型只需实现对应接口。
